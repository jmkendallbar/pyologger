---
title: "SaturationProfiles"
author: "Jessica Kendall-Bar"
date: "2023-05-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Setup ----
library(ggplot2)
library(lubridate)
library(here)
library(tidyverse)
library(scales)
library(dplyr)
library(ggnewscale)
library(cowplot)
library(ggeasy)
library(conflicted)
library(devtools)
library(circular)
library(geosphere)
library(RColorBrewer)

conflict_prefer("here","here")
conflict_prefer("filter","dplyr")
conflict_prefer("mutate","dplyr")
conflict_prefer("sd","stats")

# Read in sleep data ----
dive_ix <- read_csv(file = here("Data/00_PenguinDiveCategorization_A-and-B.csv"))
dive_data <- read_csv(file = here("Data/00_PenguinSaturations_A-and-B.csv"))

# Convert datetime columns to POSIXct
dive_data$Time <- ymd_hms(dive_data$Fixed_DateTime)
dive_ix$starttime <- ymd_hms(dive_ix$starttime)
dive_ix$endtime <- ymd_hms(dive_ix$endtime)

# create a new column 'type' in dive_data
dive_data <- dive_data %>%
  mutate(Type = "SURFACE",
         Dive_number = 0,
         Dive_duration = 0,
         Max_depth = 0)

# loop through each dive interval
for (i in seq_along(dive_ix$starttime)) {
  # get the start and end times of the dive interval
  start_time <- dive_ix$starttime[i]
  end_time <- dive_ix$endtime[i]
  Type0 <- dive_ix$Type[i]
  DiveNO <- dive_ix$`Dive Number`[i]
  DiveDur <- dive_ix$`dive duration`[i]
  MaxDepth <- dive_ix$`max depth`[i]
  # set the type for the interval
  dive_data <- dive_data %>%
    mutate(Type = if_else(between(Time, start_time, end_time), Type0, Type),
           Dive_number = if_else(between(Time, start_time, end_time), DiveNO, Dive_number),
           Dive_duration = if_else(between(Time, start_time, end_time), DiveDur, Dive_duration),
           Max_depth = if_else(between(Time, start_time, end_time), MaxDepth, Max_depth))
}



dive_data_summary <- dive_data %>% 
  group_by(`Bird ID`) %>% 
  mutate(Seconds_Elapsed = as.numeric(Time-Time[1])) %>% 
  group_by(`Dive_number`) %>% 
  mutate(Seconds_into_dive = as.numeric(Time-Time[1])) %>% 
  drop_na(Dive_number)

dive_data_summary <- dive_data %>% 
  group_by(`Bird ID`,`Type`) %>% 
  filter(`Dive_duration` > 0) %>% 
  summarise(meanSAT = mean(SAT),
            number = n())

dive_data_summary <- dive_data %>% 
  group_by(`Bird ID`,`Dive_number`,`Dive_duration`) %>% 
  filter(`Dive_duration` > 0) %>% 
  summarise(mean(SAT))

# create color palette
my_palette <- colorRampPalette(brewer.pal(9, "YlOrRd"))

AB_dive_plot <- ggplot(dive_data, aes(x = Seconds_into_dive, y = SAT, color = Dive_duration)) +
  geom_point(size = 1)+
  geom_smooth() +
  scale_color_gradientn(colors = my_palette(10), na.value = "grey50") +
  labs(title = "SAT by Dive Duration", x = "Seconds into Dive", y = "SAT", color = "Dive Duration") +
  facet_grid(rows = as.factor(Type)) +
  theme_minimal()
AB_dive_plot

avg_dive_duration <- dive_data %>%
  group_by(Type) %>%
  summarize(avg_duration = mean(Dive_duration),
            num_obs = n(),
            num_dives = length(unique(Dive_number)))

# Create the plot
type_AB_dives <- ggplot(dive_data, aes(x = Seconds_into_dive/60, y = SAT)) +
  #geom_path(aes(color = Dive_duration, group = interaction(Type,Dive_duration))) +
  geom_smooth(aes(color = Dive_duration, group = interaction(Type, Dive_duration)), se = FALSE, size=0.25, method = "loess") +
  geom_smooth(aes(color = Dive_duration, group = Type), 
              size = 1, se = TRUE, method = "loess") +
  scale_color_gradientn(colors = brewer.pal(9, "YlGnBu")) +
  scale_x_continuous(limits = c(0,1200/60))+
  scale_y_continuous(limits = c(0,100))+
  facet_wrap(~ Type, ncol = 2, scales = "free") +
  labs(x = "Minutes into Dive", y = "SAT", color = "Dive Duration (min)", title = paste("Dive Profiles of ", avg_dive_duration$num_dives[1], "A dives &", 
  avg_dive_duration$num_dives[2],"B dives")) +
  theme_minimal()+
  theme(legend.position = "bottom")
type_AB_dives

type_AB_dives <- ggplot(dive_data, aes(x = Seconds_into_dive/60, y = SAT)) +
  #geom_path(aes(color = Dive_duration, group = interaction(Type,Dive_duration))) +
  geom_smooth(aes(color = Max_depth, group = interaction(Type, Max_depth)), se = FALSE, size=0.25, method = "loess") +
  geom_smooth(aes(color =  Max_depth, group = Type), 
              size = 1, se = TRUE, method = "loess") +
  scale_color_gradientn(colors = brewer.pal(9, "YlGnBu")) +
  scale_x_continuous(limits = c(0,1200/60))+
  scale_y_continuous(limits = c(0,100))+
  facet_wrap(~ Type, ncol = 2, scales = "free") +
  labs(x = "Minutes into Dive", y = "SAT", color = "Dive Duration (min)", title = paste("Dive Profiles of ", avg_dive_duration$num_dives[1], "A dives &", 
  avg_dive_duration$num_dives[2],"B dives")) +
  theme_minimal()+
  theme(legend.position = "bottom")
type_AB_dives

ggsave(plot=type_AB_dives, 
       here("Analysis/Figures","type_AB_dives.pdf"), 
       bg = "transparent",limitsize=FALSE,
       width=10,
       height=4)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
